<section class="chat-layout">
  <app-header class="fixed-header"></app-header>

  <div class="chat-viewport">
    <div class="chat-container" #chatBodyRef>

      <!-- Empty State -->
      <div *ngIf="messages.length === 0" class="empty-state">
        <div class="logo-pulse">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
        </div>
        <h2>Hello, I'm the PulseIQ AI Assistant</h2>
        <p>How can I help you today?</p>
      </div>

      <!-- Message Loop -->
      <div class="message-list">
        <div *ngFor="let message of messages" class="message-row"
          [ngClass]="{'user-row': message.type === 'user', 'bot-row': message.type === 'bot'}">

          <!-- Bot Avatar (Only show for bot) -->
          <div *ngIf="message.type === 'bot'" class="avatar bot-avatar">
            <svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2">
              <path d="M12 2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2 2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z" />
              <path d="M12 16a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-2a2 2 0 0 1 2-2z" />
              <path d="M5 9v6h14V9a7 7 0 0 0-14 0z" />
            </svg>
          </div>

          <!-- Message Bubble -->
          <div class="bubble">
            <markdown [data]="message.content"></markdown>

            <div *ngIf="message.itineraries && message.itineraries.length > 0" class="cards-grid">
              <div class="mini-card" *ngFor="let trip of message.itineraries">
                <div class="card-img-placeholder"></div>
                <div class="card-info">
                  <strong>{{ trip.holiday_name }}</strong>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- Loading Indicator -->
        <div *ngIf="isLoading" class="message-row bot-row">
          <div class="avatar bot-avatar">
            <svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2">
              <path d="M12 2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2 2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z" />
              <path d="M12 16a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-2a2 2 0 0 1 2-2z" />
              <path d="M5 9v6h14V9a7 7 0 0 0-14 0z" />
            </svg>
          </div>
          <div class="bubble">
            <div class="typing-dots">
              <span></span><span></span><span></span>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Input Area -->
  <div class="input-area">
    <div class="input-glass-wrapper">
      <textarea #userMessageInput placeholder="Type your message..."
        (keydown.enter)="sendMessage(userMessageInput.value); $event.preventDefault()"
        (input)="adjustTextareaHeight($event)" rows="1"></textarea>
      <button class="send-btn" [disabled]="isLoading || !userMessageInput.value"
        (click)="sendMessage(userMessageInput.value)">
        <!-- Solid icon for white background visibility -->
        <svg viewBox="0 0 24 24">
          <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
        </svg>
      </button>
    </div>
    <p class="disclaimer">PulseIQ AI generated content. Please verify important details.</p>
  </div>
</section>